import os
import json
import requests
from flask import Flask, request
from binance.client import Client

app = Flask(__name__)

TOKEN = os.getenv("8043421905:AAFBBxqBkSBiHrR6BrTYUow4PKl6QGFbIUY")
CHAT_ID = os.getenv("386425654")
BINANCE_KEY = os.getenv("09cfd0f1cddc27bf2e45185356d21c8c4911abb8f34768f5400cca26f0928113")
BINANCE_SECRET = os.getenv("cabe13687bab1b8df4d5cacfc8161e18e2d05fdff3cd79c595ab511db8cf97a7")
client = Client(BINANCE_KEY, BINANCE_SECRET, testnet=True)

@app.route("/webhook", methods=["POST"])
def webhook():
    data = request.json
    message = f"ðŸ“ˆ {data.get('action', 'SIGNAL')} | {data.get('symbol', '')} | TF: {data.get('timeframe', '')}\nðŸ’° Entry: {data.get('entry', '')}"

    url = f"https://api.telegram.org/bot{TOKEN}/sendMessage"
    payload = {"chat_id": CHAT_ID, "text": message}
    requests.post(url, json=payload)

    try:
        if data.get("action") == "LONG":
            client.futures_create_order(symbol=data.get("symbol", "BTCUSDT"), side="BUY", type="MARKET", quantity=0.01)
        elif data.get("action") == "SHORT":
            client.futures_create_order(symbol=data.get("symbol", "BTCUSDT"), side="SELL", type="MARKET", quantity=0.01)
    except Exception as e:
        error_message = f"âš  Binance API error: {e}"
        requests.post(url, json={"chat_id": CHAT_ID, "text": error_message})

    return "ok"

if __name__ == "__main__":
    app.run(debug=True, host="0.0.0.0", port=5000)
